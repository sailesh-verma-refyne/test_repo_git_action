name: Generate Release Notes

on:
  push:
    branches:
      - master # for customer-app
      - dev # for customer-pwa dev
      - release # for customer-app release

jobs:
  release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Get Commits
        id: commits
        uses: niteoweb/action-release-notes@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract ClickUp Tickets
        id: clickup
        run: |
          echo "ğŸ§  Extracting ClickUp URLs from commits..."
          echo "${{ steps.commits.outputs.notes }}" | grep -Eo 'https:\/\/app.clickup.com\/t\/[a-zA-Z0-9]+' | sort | uniq > clickup_urls.txt
          echo "ğŸ“ ClickUp URLs:"
          cat clickup_urls.txt

      - name: Post to Slack
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "*ğŸ”” Release Notification - ${{ github.ref_name }}* \n\n*ClickUp Tickets:* \n$(cat clickup_urls.txt | sed 's/^/- /' | paste -sd '\n')"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_RELEASE_HOOK }}
